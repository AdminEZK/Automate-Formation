# üîê Int√©gration Yousign - Signature √âlectronique

**Version** : 1.0 - MVP  
**Date** : 8 octobre 2025

---

## üéØ OBJECTIF

Int√©grer **Yousign** pour la signature √©lectronique des documents dans le MVP, notamment :
- Convention de formation
- Contrat formateur (sous-traitance)

---

## üìã DOCUMENTS √Ä SIGNER

### 1. **Convention de Formation** (Client)
- **Signataires** : 2
  - Repr√©sentant OF (organisme)
  - Repr√©sentant entreprise cliente
- **D√©clenchement** : Apr√®s acceptation proposition
- **Statut** : `en_attente` ‚Üí `confirmee`

### 2. **Contrat Formateur** (Sous-traitance)
- **Signataires** : 2
  - Repr√©sentant OF
  - Formateur
- **D√©clenchement** : Lors de la mobilisation formateur
- **Statut** : Contrat actif

---

## üîß CONFIGURATION YOUSIGN

### 1. Cr√©er un Compte

1. **Inscription** : https://yousign.com
2. **Plan** : Starter (29‚Ç¨/mois) ou Business (99‚Ç¨/mois)
3. **Mode** : Production

### 2. Obtenir les Credentials

```bash
# Dans le dashboard Yousign
# Settings > API Keys

YOUSIGN_API_KEY=your_api_key_here
YOUSIGN_ENVIRONMENT=production  # ou 'sandbox' pour tests
```

### 3. Configuration .env

```bash
# .env
YOUSIGN_API_KEY=ys_xxxxxxxxxxxxxxxxxxxxx
YOUSIGN_ENVIRONMENT=production
YOUSIGN_WEBHOOK_URL=https://votre-domaine.com/api/webhooks/yousign
```

---

## üíª IMPL√âMENTATION

### 1. Installation

```bash
npm install @yousign/yousign-api
```

### 2. Service Yousign

```javascript
// services/yousignService.js
import { Yousign } from '@yousign/yousign-api';

const yousign = new Yousign({
  apiKey: process.env.YOUSIGN_API_KEY,
  environment: process.env.YOUSIGN_ENVIRONMENT
});

/**
 * Cr√©er une proc√©dure de signature
 */
export async function createSignatureProcedure(documentData) {
  const {
    documentPath,
    documentName,
    signers,
    sessionId
  } = documentData;

  try {
    // 1. Upload du document
    const file = await yousign.files.create({
      name: documentName,
      content: documentPath, // Base64 ou URL
      type: 'signable'
    });

    // 2. Cr√©er la proc√©dure
    const procedure = await yousign.procedures.create({
      name: `Signature - ${documentName}`,
      description: `Session de formation #${sessionId}`,
      start: true, // D√©marrer imm√©diatement
      ordered: false, // Signatures dans n'importe quel ordre
      metadata: {
        session_id: sessionId,
        document_type: 'convention'
      }
    });

    // 3. Ajouter les signataires
    for (const signer of signers) {
      await yousign.members.create({
        procedure: procedure.id,
        user: {
          firstname: signer.prenom,
          lastname: signer.nom,
          email: signer.email,
          phone: signer.telephone
        },
        fileObjects: [{
          file: file.id,
          page: 1, // Page o√π signer
          position: signer.position || '100,100,300,150', // x,y,width,height
          mention: 'Lu et approuv√©',
          mention2: 'Signature pr√©c√©d√©e de la mention "Lu et approuv√©"'
        }]
      });
    }

    return {
      success: true,
      procedureId: procedure.id,
      fileId: file.id
    };

  } catch (error) {
    console.error('Erreur Yousign:', error);
    throw error;
  }
}

/**
 * V√©rifier le statut d'une proc√©dure
 */
export async function checkSignatureStatus(procedureId) {
  try {
    const procedure = await yousign.procedures.get(procedureId);
    
    return {
      status: procedure.status, // 'draft', 'active', 'finished', 'expired', 'refused'
      signed: procedure.status === 'finished',
      members: procedure.members.map(m => ({
        name: `${m.firstname} ${m.lastname}`,
        email: m.email,
        status: m.status,
        signedAt: m.operationDate
      }))
    };
  } catch (error) {
    console.error('Erreur v√©rification:', error);
    throw error;
  }
}

/**
 * T√©l√©charger le document sign√©
 */
export async function downloadSignedDocument(fileId) {
  try {
    const file = await yousign.files.download(fileId);
    return file; // Buffer du PDF sign√©
  } catch (error) {
    console.error('Erreur t√©l√©chargement:', error);
    throw error;
  }
}

/**
 * Annuler une proc√©dure
 */
export async function cancelSignatureProcedure(procedureId) {
  try {
    await yousign.procedures.cancel(procedureId);
    return { success: true };
  } catch (error) {
    console.error('Erreur annulation:', error);
    throw error;
  }
}
```

### 3. Route API

```javascript
// routes/signature.js
import express from 'express';
import { 
  createSignatureProcedure, 
  checkSignatureStatus,
  downloadSignedDocument 
} from '../services/yousignService.js';
import { supabase } from '../services/supabaseService.js';

const router = express.Router();

/**
 * POST /api/signature/convention/:sessionId
 * Envoyer une convention pour signature
 */
router.post('/convention/:sessionId', async (req, res) => {
  try {
    const { sessionId } = req.params;

    // 1. R√©cup√©rer les donn√©es de la session
    const { data: session } = await supabase
      .from('sessions_formation')
      .select(`
        *,
        entreprise:entreprises(*),
        formation:formations_catalogue(*)
      `)
      .eq('id', sessionId)
      .single();

    // 2. G√©n√©rer la convention PDF
    const conventionPdf = await generateConventionPDF(session);

    // 3. D√©finir les signataires
    const signers = [
      {
        prenom: process.env.OF_REPRESENTANT_PRENOM,
        nom: process.env.OF_REPRESENTANT_NOM,
        email: process.env.OF_REPRESENTANT_EMAIL,
        telephone: process.env.OF_REPRESENTANT_TELEPHONE,
        position: '100,650,300,700' // Position signature page 1
      },
      {
        prenom: session.entreprise.representant_legal_prenom,
        nom: session.entreprise.representant_legal_nom,
        email: session.entreprise.email_contact,
        telephone: session.entreprise.telephone,
        position: '350,650,550,700' // Position signature page 1
      }
    ];

    // 4. Cr√©er la proc√©dure Yousign
    const result = await createSignatureProcedure({
      documentPath: conventionPdf,
      documentName: `Convention_Formation_${sessionId}.pdf`,
      signers,
      sessionId
    });

    // 5. Enregistrer dans la BDD
    await supabase
      .from('documents')
      .insert({
        session_formation_id: sessionId,
        type: 'convention',
        file_name: `Convention_${sessionId}.pdf`,
        yousign_procedure_id: result.procedureId,
        yousign_file_id: result.fileId,
        status: 'pending_signature'
      });

    res.json({
      success: true,
      message: 'Convention envoy√©e pour signature',
      procedureId: result.procedureId
    });

  } catch (error) {
    console.error('Erreur:', error);
    res.status(500).json({ error: error.message });
  }
});

/**
 * GET /api/signature/status/:procedureId
 * V√©rifier le statut d'une signature
 */
router.get('/status/:procedureId', async (req, res) => {
  try {
    const { procedureId } = req.params;
    const status = await checkSignatureStatus(procedureId);
    res.json(status);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

/**
 * POST /api/webhooks/yousign
 * Webhook Yousign (notifications)
 */
router.post('/webhooks/yousign', async (req, res) => {
  try {
    const event = req.body;

    console.log('Webhook Yousign:', event);

    // V√©rifier la signature du webhook (s√©curit√©)
    // TODO: Impl√©menter v√©rification signature

    switch (event.eventName) {
      case 'procedure.finished':
        await handleProcedureFinished(event);
        break;
      
      case 'procedure.refused':
        await handleProcedureRefused(event);
        break;
      
      case 'member.finished':
        await handleMemberSigned(event);
        break;
    }

    res.json({ received: true });

  } catch (error) {
    console.error('Erreur webhook:', error);
    res.status(500).json({ error: error.message });
  }
});

/**
 * G√©rer la fin d'une proc√©dure (tous sign√©s)
 */
async function handleProcedureFinished(event) {
  const { procedure } = event;
  
  // 1. T√©l√©charger le document sign√©
  const signedPdf = await downloadSignedDocument(procedure.files[0].id);
  
  // 2. Uploader dans Supabase Storage
  const fileName = `conventions/signed_${procedure.id}.pdf`;
  await supabase.storage
    .from('documents')
    .upload(fileName, signedPdf);
  
  // 3. Mettre √† jour la BDD
  await supabase
    .from('documents')
    .update({
      status: 'signed',
      file_path: fileName,
      signed_at: new Date()
    })
    .eq('yousign_procedure_id', procedure.id);
  
  // 4. Mettre √† jour le statut de la session
  const { data: doc } = await supabase
    .from('documents')
    .select('session_formation_id')
    .eq('yousign_procedure_id', procedure.id)
    .single();
  
  await supabase
    .from('sessions_formation')
    .update({ statut: 'confirmee' })
    .eq('id', doc.session_formation_id);
  
  // 5. Envoyer email de confirmation
  // TODO: Impl√©menter avec Resend
}

/**
 * G√©rer le refus d'une proc√©dure
 */
async function handleProcedureRefused(event) {
  const { procedure } = event;
  
  await supabase
    .from('documents')
    .update({ status: 'refused' })
    .eq('yousign_procedure_id', procedure.id);
  
  // TODO: Notifier l'OF
}

/**
 * G√©rer la signature d'un membre
 */
async function handleMemberSigned(event) {
  const { member } = event;
  
  console.log(`${member.firstname} ${member.lastname} a sign√©`);
  
  // TODO: Notifier l'autre partie
}

export default router;
```

### 4. Workflow Windmill

```python
# windmill_flows/send_convention_signature.py
import requests
import os

def main(session_id: str):
    """
    Envoyer une convention pour signature via Yousign
    """
    api_url = os.getenv('API_URL')
    
    # Appeler l'API pour cr√©er la proc√©dure
    response = requests.post(
        f'{api_url}/api/signature/convention/{session_id}'
    )
    
    if response.status_code == 200:
        result = response.json()
        return {
            'success': True,
            'procedure_id': result['procedureId'],
            'message': 'Convention envoy√©e pour signature'
        }
    else:
        raise Exception(f'Erreur: {response.text}')
```

---

## üîî WEBHOOKS YOUSIGN

### Configuration

1. **Dans Yousign Dashboard** :
   - Settings > Webhooks
   - URL : `https://votre-domaine.com/api/webhooks/yousign`
   - Events : 
     - `procedure.finished`
     - `procedure.refused`
     - `member.finished`

### S√©curit√©

```javascript
// V√©rifier la signature du webhook
import crypto from 'crypto';

function verifyYousignWebhook(payload, signature) {
  const secret = process.env.YOUSIGN_WEBHOOK_SECRET;
  const hash = crypto
    .createHmac('sha256', secret)
    .update(JSON.stringify(payload))
    .digest('hex');
  
  return hash === signature;
}
```

---

## üìä TABLE SUPABASE

```sql
-- Ajouter colonnes Yousign dans la table documents
ALTER TABLE documents ADD COLUMN yousign_procedure_id VARCHAR(255);
ALTER TABLE documents ADD COLUMN yousign_file_id VARCHAR(255);
ALTER TABLE documents ADD COLUMN status VARCHAR(50) DEFAULT 'draft';
ALTER TABLE documents ADD COLUMN signed_at TIMESTAMP;

-- Index
CREATE INDEX idx_documents_yousign_procedure ON documents(yousign_procedure_id);
```

---

## üéØ PARCOURS UTILISATEUR

### 1. OF envoie la convention
```
OF clique "Envoyer pour signature"
  ‚Üì
Syst√®me g√©n√®re PDF
  ‚Üì
Yousign cr√©e proc√©dure
  ‚Üì
Emails envoy√©s aux 2 signataires
```

### 2. Signataires signent
```
Client re√ßoit email Yousign
  ‚Üì
Clique sur lien
  ‚Üì
Lit la convention
  ‚Üì
Signe √©lectroniquement
  ‚Üì
Confirmation
```

### 3. Document finalis√©
```
Tous ont sign√©
  ‚Üì
Webhook ‚Üí Syst√®me notifi√©
  ‚Üì
PDF sign√© t√©l√©charg√©
  ‚Üì
Stock√© dans Supabase
  ‚Üì
Statut session ‚Üí confirmee
  ‚Üì
Emails de confirmation
```

---

## üí∞ CO√õTS YOUSIGN

### Plans
- **Starter** : 29‚Ç¨/mois - 10 signatures/mois
- **Business** : 99‚Ç¨/mois - 50 signatures/mois
- **Enterprise** : Sur devis - Illimit√©

### Signatures suppl√©mentaires
- 2‚Ç¨ par signature au-del√† du forfait

---

## ‚úÖ AVANTAGES

- ‚úÖ **L√©gal** : Valeur juridique (eIDAS)
- ‚úÖ **Rapide** : Signature en 2 minutes
- ‚úÖ **Tra√ßabilit√©** : Horodatage, certificat
- ‚úÖ **UX** : Interface simple et claire
- ‚úÖ **Mobile** : Signature sur smartphone
- ‚úÖ **Fran√ßais** : Conforme RGPD

---

## üöÄ PROCHAINES √âTAPES

1. ‚úÖ Cr√©er compte Yousign
2. ‚úÖ Obtenir API Key
3. ‚úÖ Impl√©menter service
4. ‚úÖ Tester en sandbox
5. ‚úÖ Configurer webhooks
6. ‚úÖ Passer en production

---

**Avec Yousign, la signature des conventions passe de 3 jours (courrier) √† 5 minutes (√©lectronique) !** ‚ö°
