{
  "flows": [
    {
      "name": "nouvelle_demande_formation",
      "summary": "Créer une nouvelle demande de formation",
      "description": "Ce flow permet de créer une nouvelle demande de formation avec gestion des entreprises, formations et participants",
      "value": {
        "modules": [
          {
            "id": "create_request",
            "value": {
              "type": "script",
              "path": "u/francois/create_request",
              "input": {
                "entreprise": {
                  "id": null,
                  "nom": "",
                  "adresse": "",
                  "code_postal": "",
                  "ville": "",
                  "pays": "France",
                  "email_contact": "",
                  "telephone_contact": "",
                  "nom_contact": ""
                },
                "formation": {
                  "id": null,
                  "titre": "",
                  "description": "",
                  "duree_jours": 1,
                  "prix_ht_jour": 1200
                },
                "session": {
                  "date_debut": "",
                  "lieu": "À distance",
                  "format": "distanciel",
                  "nombre_participants": 1,
                  "commentaires": ""
                },
                "participants": [
                  {
                    "nom": "",
                    "prenom": "",
                    "email": "",
                    "fonction": ""
                  }
                ],
                "envoyer_email_confirmation": true
              }
            }
          }
        ],
        "schema": {
          "properties": {
            "entreprise": {
              "title": "Informations de l'entreprise",
              "type": "object",
              "properties": {
                "id": {
                  "title": "ID Entreprise existante (laisser vide pour nouvelle)",
                  "type": "string",
                  "format": "uuid"
                },
                "nom": {
                  "title": "Nom de l'entreprise",
                  "type": "string"
                },
                "adresse": {
                  "title": "Adresse",
                  "type": "string"
                },
                "code_postal": {
                  "title": "Code postal",
                  "type": "string"
                },
                "ville": {
                  "title": "Ville",
                  "type": "string"
                },
                "pays": {
                  "title": "Pays",
                  "type": "string",
                  "default": "France"
                },
                "email_contact": {
                  "title": "Email du contact",
                  "type": "string",
                  "format": "email"
                },
                "telephone_contact": {
                  "title": "Téléphone du contact",
                  "type": "string"
                },
                "nom_contact": {
                  "title": "Nom du contact",
                  "type": "string"
                }
              },
              "required": ["nom", "email_contact"]
            },
            "formation": {
              "title": "Informations de la formation",
              "type": "object",
              "properties": {
                "id": {
                  "title": "ID Formation existante (laisser vide pour nouvelle)",
                  "type": "string",
                  "format": "uuid"
                },
                "titre": {
                  "title": "Titre de la formation",
                  "type": "string"
                },
                "description": {
                  "title": "Description",
                  "type": "string"
                },
                "duree_jours": {
                  "title": "Durée (jours)",
                  "type": "integer",
                  "minimum": 1,
                  "default": 1
                },
                "prix_ht_jour": {
                  "title": "Prix HT par jour",
                  "type": "number",
                  "default": 1200
                }
              },
              "required": ["titre", "duree_jours", "prix_ht_jour"]
            },
            "session": {
              "title": "Informations de la session",
              "type": "object",
              "properties": {
                "date_debut": {
                  "title": "Date de début",
                  "type": "string",
                  "format": "date"
                },
                "lieu": {
                  "title": "Lieu",
                  "type": "string",
                  "default": "À distance"
                },
                "format": {
                  "title": "Format",
                  "type": "string",
                  "enum": ["presentiel", "distanciel", "mixte"],
                  "default": "distanciel"
                },
                "nombre_participants": {
                  "title": "Nombre de participants",
                  "type": "integer",
                  "minimum": 1,
                  "default": 1
                },
                "commentaires": {
                  "title": "Commentaires",
                  "type": "string"
                }
              },
              "required": ["date_debut", "format"]
            },
            "participants": {
              "title": "Participants",
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "nom": {
                    "title": "Nom",
                    "type": "string"
                  },
                  "prenom": {
                    "title": "Prénom",
                    "type": "string"
                  },
                  "email": {
                    "title": "Email",
                    "type": "string",
                    "format": "email"
                  },
                  "fonction": {
                    "title": "Fonction",
                    "type": "string"
                  }
                },
                "required": ["nom", "prenom", "email"]
              }
            },
            "envoyer_email_confirmation": {
              "title": "Envoyer un email de confirmation",
              "type": "boolean",
              "default": true
            }
          },
          "required": ["entreprise", "formation", "session", "participants"]
        }
      }
    },
    {
      "name": "liste_sessions_formation",
      "summary": "Lister les sessions de formation",
      "description": "Ce flow permet de lister et filtrer les sessions de formation",
      "value": {
        "modules": [
          {
            "id": "list_sessions",
            "value": {
              "type": "script",
              "path": "u/francois/list_sessions",
              "input": {
                "statut": null,
                "periode": "30j",
                "entreprise_id": null,
                "jours": 30,
                "include_participants": true
              }
            }
          }
        ],
        "schema": {
          "properties": {
            "statut": {
              "title": "Statut",
              "type": "string",
              "enum": [null, "demande", "en_attente", "confirmee", "convoquee", "terminee", "archivee", "annulee"],
              "default": null
            },
            "periode": {
              "title": "Période",
              "type": "string",
              "enum": ["7j", "30j", "90j", "tous"],
              "default": "30j"
            },
            "entreprise_id": {
              "title": "ID Entreprise (optionnel)",
              "type": "string",
              "format": "uuid"
            },
            "include_participants": {
              "title": "Inclure les participants",
              "type": "boolean",
              "default": true
            }
          }
        }
      }
    },
    {
      "name": "generer_documents",
      "summary": "Générer les documents de formation",
      "description": "Ce flow permet de générer les documents pour une session de formation (convocations, certificats, évaluations)",
      "value": {
        "modules": [
          {
            "id": "generate_documents",
            "value": {
              "type": "script",
              "path": "u/francois/generate_documents",
              "input": {
                "session_id": "",
                "type_document": "convocation",
                "inclure_tous_participants": true,
                "participant_id": null,
                "envoyer_email": false,
                "sauvegarder_supabase": true,
                "email_test": null
              }
            }
          }
        ],
        "schema": {
          "properties": {
            "session_id": {
              "title": "ID de la session",
              "type": "string",
              "format": "uuid"
            },
            "type_document": {
              "title": "Type de document",
              "type": "string",
              "enum": ["convocation", "certificat", "evaluation"],
              "default": "convocation"
            },
            "inclure_tous_participants": {
              "title": "Pour tous les participants",
              "type": "boolean",
              "default": true
            },
            "participant_id": {
              "title": "ID Participant spécifique (optionnel)",
              "type": "string",
              "format": "uuid"
            },
            "envoyer_email": {
              "title": "Envoyer par email",
              "type": "boolean",
              "default": false
            },
            "sauvegarder_supabase": {
              "title": "Sauvegarder dans Supabase",
              "type": "boolean",
              "default": true
            },
            "email_test": {
              "title": "Email de test (optionnel)",
              "type": "string",
              "format": "email"
            }
          },
          "required": ["session_id", "type_document"]
        }
      }
    },
    {
      "name": "envoyer_convocations",
      "summary": "Envoyer les emails de convocation",
      "description": "Ce flow permet d'envoyer les emails de convocation aux participants d'une session",
      "value": {
        "modules": [
          {
            "id": "send_invitations",
            "value": {
              "type": "script",
              "path": "u/francois/send_invitations",
              "input": {
                "session_id": "",
                "participant_id": null,
                "inclure_tous_participants": true,
                "generer_documents": true,
                "mettre_a_jour_statut": true,
                "email_test": null
              }
            }
          }
        ],
        "schema": {
          "properties": {
            "session_id": {
              "title": "ID de la session",
              "type": "string",
              "format": "uuid"
            },
            "participant_id": {
              "title": "ID Participant spécifique (optionnel)",
              "type": "string",
              "format": "uuid"
            },
            "inclure_tous_participants": {
              "title": "Pour tous les participants",
              "type": "boolean",
              "default": true
            },
            "generer_documents": {
              "title": "Générer les documents",
              "type": "boolean",
              "default": true
            },
            "mettre_a_jour_statut": {
              "title": "Mettre à jour le statut",
              "type": "boolean",
              "default": true
            },
            "email_test": {
              "title": "Email de test (optionnel)",
              "type": "string",
              "format": "email"
            }
          },
          "required": ["session_id"]
        }
      }
    },
    {
      "name": "dashboard_formation",
      "summary": "Tableau de bord des formations",
      "description": "Tableau de bord principal pour gérer les formations",
      "value": {
        "modules": [
          {
            "id": "header",
            "value": {
              "type": "rawscript",
              "content": "return `<div style=\"padding: 20px; background-color: #f5f5f5; border-radius: 8px; margin-bottom: 20px;\">\n  <h1 style=\"color: #333;\">Gestion des Formations</h1>\n  <p>Bienvenue dans le système de gestion des formations. Utilisez les outils ci-dessous pour gérer vos sessions.</p>\n</div>`",
              "language": "typescript"
            }
          },
          {
            "id": "stats",
            "value": {
              "type": "script",
              "path": "u/francois/list_sessions",
              "input": {}
            }
          },
          {
            "id": "stats_display",
            "value": {
              "type": "rawscript",
              "content": "import { RawScript } from \"@windmill/react-components\";\n\ninterface Props {\n  stats: any;\n}\n\nexport default function StatsDisplay({ stats }: Props) {\n  // Compter les sessions par statut\n  const countByStatus = {};\n  stats.forEach(session => {\n    const status = session.statut || \"inconnu\";\n    countByStatus[status] = (countByStatus[status] || 0) + 1;\n  });\n  \n  // Calculer les sessions à venir (date_debut > aujourd'hui)\n  const today = new Date();\n  const upcomingSessions = stats.filter(session => {\n    if (!session.date_debut) return false;\n    const sessionDate = new Date(session.date_debut);\n    return sessionDate > today;\n  });\n  \n  return (\n    <div style={{ display: \"flex\", flexWrap: \"wrap\", gap: \"20px\", marginBottom: \"30px\" }}>\n      <div style={{ flex: \"1\", minWidth: \"200px\", padding: \"20px\", backgroundColor: \"#e3f2fd\", borderRadius: \"8px\", boxShadow: \"0 2px 4px rgba(0,0,0,0.1)\" }}>\n        <h3>Sessions totales</h3>\n        <div style={{ fontSize: \"32px\", fontWeight: \"bold\" }}>{stats.length}</div>\n      </div>\n      \n      <div style={{ flex: \"1\", minWidth: \"200px\", padding: \"20px\", backgroundColor: \"#e8f5e9\", borderRadius: \"8px\", boxShadow: \"0 2px 4px rgba(0,0,0,0.1)\" }}>\n        <h3>Sessions à venir</h3>\n        <div style={{ fontSize: \"32px\", fontWeight: \"bold\" }}>{upcomingSessions.length}</div>\n      </div>\n      \n      <div style={{ flex: \"1\", minWidth: \"200px\", padding: \"20px\", backgroundColor: \"#fff3e0\", borderRadius: \"8px\", boxShadow: \"0 2px 4px rgba(0,0,0,0.1)\" }}>\n        <h3>En attente</h3>\n        <div style={{ fontSize: \"32px\", fontWeight: \"bold\" }}>{countByStatus[\"en_attente\"] || 0}</div>\n      </div>\n      \n      <div style={{ flex: \"1\", minWidth: \"200px\", padding: \"20px\", backgroundColor: \"#e8eaf6\", borderRadius: \"8px\", boxShadow: \"0 2px 4px rgba(0,0,0,0.1)\" }}>\n        <h3>Confirmées</h3>\n        <div style={{ fontSize: \"32px\", fontWeight: \"bold\" }}>{countByStatus[\"confirmee\"] || 0}</div>\n      </div>\n    </div>\n  );\n}",
              "language": "tsx",
              "input": {
                "stats": "$result:stats"
              }
            }
          },
          {
            "id": "actions",
            "value": {
              "type": "rawscript",
              "content": "return `<div style=\"display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px;\">\n  <a href=\"/flows/u/francois/nouvelle_demande_formation\" style=\"flex: 1; min-width: 200px; padding: 20px; background-color: #4caf50; color: white; text-decoration: none; border-radius: 8px; text-align: center; font-weight: bold;\">\n    ➕ Nouvelle demande\n  </a>\n  <a href=\"/flows/u/francois/liste_sessions_formation\" style=\"flex: 1; min-width: 200px; padding: 20px; background-color: #2196f3; color: white; text-decoration: none; border-radius: 8px; text-align: center; font-weight: bold;\">\n    📋 Liste des sessions\n  </a>\n  <a href=\"/flows/u/francois/generer_documents\" style=\"flex: 1; min-width: 200px; padding: 20px; background-color: #ff9800; color: white; text-decoration: none; border-radius: 8px; text-align: center; font-weight: bold;\">\n    📄 Générer documents\n  </a>\n  <a href=\"/flows/u/francois/envoyer_convocations\" style=\"flex: 1; min-width: 200px; padding: 20px; background-color: #9c27b0; color: white; text-decoration: none; border-radius: 8px; text-align: center; font-weight: bold;\">\n    ✉️ Envoyer convocations\n  </a>\n</div>`",
              "language": "typescript"
            }
          },
          {
            "id": "recent_sessions",
            "value": {
              "type": "script",
              "path": "u/francois/list_sessions",
              "input": {
                "jours": 30,
                "include_participants": false
              }
            }
          },
          {
            "id": "sessions_table",
            "value": {
              "type": "rawscript",
              "content": "import { RawScript } from \"@windmill/react-components\";\n\ninterface Props {\n  sessions: any[];\n}\n\nexport default function SessionsTable({ sessions }: Props) {\n  // Trier les sessions par date (les plus récentes d'abord)\n  const sortedSessions = [...sessions].sort((a, b) => {\n    if (!a.date_debut) return 1;\n    if (!b.date_debut) return -1;\n    return new Date(b.date_debut).getTime() - new Date(a.date_debut).getTime();\n  });\n  \n  // Limiter à 10 sessions\n  const recentSessions = sortedSessions.slice(0, 10);\n  \n  // Fonction pour formater la date\n  const formatDate = (dateStr) => {\n    if (!dateStr) return \"Non définie\";\n    const date = new Date(dateStr);\n    return date.toLocaleDateString();\n  };\n  \n  // Fonction pour obtenir la couleur du statut\n  const getStatusColor = (status) => {\n    const colors = {\n      \"demande\": \"#ffeb3b\",\n      \"en_attente\": \"#ff9800\",\n      \"confirmee\": \"#4caf50\",\n      \"convoquee\": \"#2196f3\",\n      \"terminee\": \"#9e9e9e\",\n      \"archivee\": \"#607d8b\",\n      \"annulee\": \"#f44336\"\n    };\n    return colors[status] || \"#9e9e9e\";\n  };\n  \n  return (\n    <div>\n      <h2>Sessions récentes</h2>\n      <table style={{ width: \"100%\", borderCollapse: \"collapse\", marginTop: \"10px\" }}>\n        <thead>\n          <tr style={{ backgroundColor: \"#f5f5f5\" }}>\n            <th style={{ padding: \"10px\", textAlign: \"left\", borderBottom: \"1px solid #ddd\" }}>Formation</th>\n            <th style={{ padding: \"10px\", textAlign: \"left\", borderBottom: \"1px solid #ddd\" }}>Entreprise</th>\n            <th style={{ padding: \"10px\", textAlign: \"left\", borderBottom: \"1px solid #ddd\" }}>Date</th>\n            <th style={{ padding: \"10px\", textAlign: \"left\", borderBottom: \"1px solid #ddd\" }}>Statut</th>\n            <th style={{ padding: \"10px\", textAlign: \"left\", borderBottom: \"1px solid #ddd\" }}>Actions</th>\n          </tr>\n        </thead>\n        <tbody>\n          {recentSessions.map((session, index) => (\n            <tr key={index} style={{ backgroundColor: index % 2 === 0 ? \"white\" : \"#fafafa\" }}>\n              <td style={{ padding: \"10px\", borderBottom: \"1px solid #ddd\" }}>{session.formation_titre || \"Non défini\"}</td>\n              <td style={{ padding: \"10px\", borderBottom: \"1px solid #ddd\" }}>{session.entreprise_nom || \"Non définie\"}</td>\n              <td style={{ padding: \"10px\", borderBottom: \"1px solid #ddd\" }}>{formatDate(session.date_debut)}</td>\n              <td style={{ padding: \"10px\", borderBottom: \"1px solid #ddd\" }}>\n                <span style={{ \n                  backgroundColor: getStatusColor(session.statut),\n                  padding: \"3px 8px\",\n                  borderRadius: \"12px\",\n                  fontSize: \"12px\",\n                  color: session.statut === \"demande\" ? \"black\" : \"white\"\n                }}>\n                  {session.statut || \"inconnu\"}\n                </span>\n              </td>\n              <td style={{ padding: \"10px\", borderBottom: \"1px solid #ddd\" }}>\n                <div style={{ display: \"flex\", gap: \"5px\" }}>\n                  <a href={`/flows/u/francois/generer_documents?session_id=${session.id}`} style={{ padding: \"3px 8px\", backgroundColor: \"#ff9800\", color: \"white\", borderRadius: \"4px\", textDecoration: \"none\", fontSize: \"12px\" }}>Documents</a>\n                  <a href={`/flows/u/francois/envoyer_convocations?session_id=${session.id}`} style={{ padding: \"3px 8px\", backgroundColor: \"#9c27b0\", color: \"white\", borderRadius: \"4px\", textDecoration: \"none\", fontSize: \"12px\" }}>Convocations</a>\n                </div>\n              </td>\n            </tr>\n          ))}\n          {recentSessions.length === 0 && (\n            <tr>\n              <td colSpan={5} style={{ padding: \"20px\", textAlign: \"center\", borderBottom: \"1px solid #ddd\" }}>Aucune session récente</td>\n            </tr>\n          )}\n        </tbody>\n      </table>\n      <div style={{ marginTop: \"20px\", textAlign: \"right\" }}>\n        <a href=\"/flows/u/francois/liste_sessions_formation\" style={{ padding: \"8px 16px\", backgroundColor: \"#2196f3\", color: \"white\", borderRadius: \"4px\", textDecoration: \"none\" }}>Voir toutes les sessions</a>\n      </div>\n    </div>\n  );\n}",
              "language": "tsx",
              "input": {
                "sessions": "$result:recent_sessions"
              }
            }
          }
        ]
      }
    }
  ]
}
